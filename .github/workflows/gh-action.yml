name: LMS GH Action

on:
  pull_request:
    branches: [main, development, v1]
  push:
    branches: [main, development, v1]

permissions:
  contents: read
  checks: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  cache:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, pdo_mysql, bcmath, soap, intl, gd, exif, iconv, imagick
          coverage: none

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Cache Vendor
        id: cache-vendor-restore
        uses: actions/cache/restore@v4
        with:
          path: 'vendor'
          key: ${{ runner.os }}-vendor-${{ hashFiles('composer.lock') }}

      - name: Cache Node Modules
        id: cache-node-modules-restore
        uses: actions/cache/restore@v4
        with:
          path: 'node_modules'
          key: ${{ runner.os }}-node-modules-${{ hashFiles('package-lock.json') }}

      - name: Install PHP dependencies
        if: steps.cache-vendor-restore.outputs.cache-hit != 'true'
        run: composer install --optimize-autoloader --no-interaction --prefer-dist

      - name: Install Node dependencies
        if: steps.cache-node-modules-restore.outputs.cache-hit != 'true'
        run: npm ci

      - name: Save Vendor Cache
        if: steps.cache-vendor-restore.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          key: ${{ steps.cache-vendor-restore.outputs.cache-primary-key }}
          path: 'vendor'

      - name: Save Node Modules Cache
        if: steps.cache-node-modules-restore.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          key: ${{ steps.cache-node-modules-restore.outputs.cache-primary-key }}
          path: 'node_modules'

  pint:
    runs-on: ubuntu-latest
    needs: cache
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: json, dom, curl, libxml, mbstring
          coverage: none

      - name: Restore Vendor Cache
        uses: actions/cache/restore@v4
        with:
          path: 'vendor'
          key: ${{ runner.os }}-vendor-${{ hashFiles('composer.lock') }}
          fail-on-cache-miss: true

      - name: Install Pint
        run: composer global require laravel/pint

      - name: Run Pint
        run: pint

      - name: Commit style changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          if ! git diff --cached --quiet; then
            git commit -m "Fix coding style [skip ci]"
            git push
          fi

  # test:
  #   name: Run Tests
  #   runs-on: ubuntu-latest
  #   needs: pint

  #   services:
  #     mysql:
  #       image: mysql:8.0
  #       env:
  #         MYSQL_ROOT_PASSWORD: password
  #         MYSQL_DATABASE: laravel_testing
  #         MYSQL_USER: laravel
  #         MYSQL_PASSWORD: password
  #       ports:
  #         - 3306:3306
  #       options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=5

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #       with:
  #         ref: ${{ github.head_ref }}

  #     - name: Setup PHP
  #       uses: shivammathur/setup-php@v2
  #       with:
  #         php-version: '8.3'
  #         extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, pdo_mysql, bcmath, soap, intl, gd, exif, iconv, imagick
  #         coverage: none

  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '18'

  #     - name: Restore Vendor Cache
  #       uses: actions/cache/restore@v4
  #       with:
  #         path: 'vendor'
  #         key: ${{ runner.os }}-vendor-${{ hashFiles('composer.lock') }}
  #         fail-on-cache-miss: true

  #     - name: Restore Node Modules Cache
  #       uses: actions/cache/restore@v4
  #       with:
  #         path: 'node_modules'
  #         key: ${{ runner.os }}-node-modules-${{ hashFiles('package-lock.json') }}
  #         fail-on-cache-miss: true

  #     - name: Copy environment file
  #       run: cp .env.example .env

  #     - name: Generate application key
  #       run: php artisan key:generate

  #     - name: Set up database configuration
  #       run: |
  #         php artisan config:clear
  #         php artisan config:cache

  #     - name: Wait for MySQL to be ready
  #       run: |
  #         until mysqladmin ping -h"127.0.0.1" -P"3306" -u"root" -p"password" --silent; do
  #           echo "Waiting for MySQL..."
  #           sleep 2
  #         done

  #     - name: Run database migrations
  #       run: php artisan migrate --force
  #       env:
  #         DB_CONNECTION: mysql
  #         DB_HOST: 127.0.0.1
  #         DB_PORT: 3306
  #         DB_DATABASE: laravel_testing
  #         DB_USERNAME: laravel
  #         DB_PASSWORD: password

  #     - name: Run database seeding
  #       run: php artisan db:seed --force
  #       env:
  #         DB_CONNECTION: mysql
  #         DB_HOST: 127.0.0.1
  #         DB_PORT: 3306
  #         DB_DATABASE: laravel_testing
  #         DB_USERNAME: laravel
  #         DB_PASSWORD: password

  #     - name: Build frontend assets
  #       run: npm run build

  #     - name: Run PHPUnit tests
  #       run: php artisan test --without-tty
  #       env:
  #         DB_CONNECTION: mysql
  #         DB_HOST: 127.0.0.1
  #         DB_PORT: 3306
  #         DB_DATABASE: laravel_testing
  #         DB_USERNAME: laravel
  #         DB_PASSWORD: password

  #     - name: Publish Test Report
  #       uses: mikepenz/action-junit-report@v4
  #       if: failure()
  #       with:
  #         detailed_summary: true
  #         summary: true
  #         check_name: "Test Results"
  #         token: ${{ secrets.GITHUB_TOKEN }}

  notify:
    runs-on: ubuntu-latest
    needs: pint #test
    if: always()
    steps:
      - name: Send Telegram notification on success
        # if: needs.test.result == 'success'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            ✅ *Build Success* - ${{ github.repository }}

            *Branch:* `${{ github.ref_name }}`
            *Commit:* `${{ github.sha }}`
            *Author:* ${{ github.actor }}
            *Message:* ${{ github.event.head_commit.message }}

            *PHP Dependencies:* Installed ✅
            *Code Style:* Fixed ✅
            *Database Migration:* Completed ✅
            *Database Seeding:* Completed ✅
            *Frontend Build:* Completed ✅
            *Tests:* Passed ✅

            [View Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

      - name: Send Telegram notification on failure
        if: needs.test.result == 'failure'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            ❌ *Build Failed* - ${{ github.repository }}

            *Branch:* `${{ github.ref_name }}`
            *Commit:* `${{ github.sha }}`
            *Author:* ${{ github.actor }}
            *Message:* ${{ github.event.head_commit.message }}

            *Status:* Build Failed ❌

            [View Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
